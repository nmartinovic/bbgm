<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBGM "Moneyball" Analyzer v2</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #e2e8f0;
            --accent: #38bdf8;
            --green: #4ade80;
            --red: #f87171;
            --yellow: #facc15;
            --purple: #c084fc;
            --muted: #94a3b8;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: var(--accent); margin-bottom: 5px; }
        h2 { color: var(--text); border-bottom: 2px solid var(--card); padding-bottom: 10px; margin-top: 0;}
        p { color: var(--muted); margin-top: 0;}
        
        /* Upload Section */
        .upload-box {
            background: var(--card);
            padding: 2rem;
            border-radius: 12px;
            border: 2px dashed var(--accent);
            text-align: center;
            margin-bottom: 2rem;
        }
        input[type="file"] {
            color: var(--text);
        }
        select, button {
            padding: 10px 15px;
            background: #334155;
            color: white;
            border: 1px solid #475569;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
        }
        button { background: var(--accent); color: var(--bg); border: none; }
        button:hover { opacity: 0.9; }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            height: fit-content;
        }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th { text-align: left; color: var(--muted); font-weight: 600; padding: 8px 4px; border-bottom: 1px solid #334155; }
        td { padding: 8px 4px; border-bottom: 1px solid #334155; }
        tr:last-child td { border-bottom: none; }
        
        /* Indicators */
        .stat-val { font-weight: bold; }
        .val-elite { color: var(--purple); text-shadow: 0 0 10px rgba(192,132,252,0.3); }
        .val-good { color: var(--green); }
        .val-mid { color: var(--yellow); }
        .val-bad { color: var(--red); }
        
        .tag {
            display: inline-block;
            font-size: 0.65em;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #1e1e2e;
        }
        .tag-stash { background: var(--purple); color: white; }
        .tag-core { background: var(--accent); color: white; }
        .tag-risk { background: var(--red); color: white; }

        #teamSelectorArea { display: none; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèÄ BBGM Roster Architect</h1>
    <p>Upload <strong>Player Ratings</strong> CSV. Prioritizes <strong>Physical Ceiling</strong> for youth and <strong>Efficiency</strong> for vets.</p>
    
    <div class="upload-box">
        <input type="file" id="csvInput" accept=".csv" />
        <div id="teamSelectorArea">
            <label for="teamSelect">Your Team:</label>
            <select id="teamSelect"></select>
            <button onclick="runAnalysis()">Analyze Roster</button>
        </div>
    </div>

    <div id="results" class="grid" style="display: none;">
        
        <!-- 1. Starting Lineup -->
        <div class="card">
            <h2>‚ö° Optimized Starting 5</h2>
            <p>Best mix of height, handling, and current ability.</p>
            <table id="starterTable">
                <thead><tr><th>Name (Age)</th><th>Role</th><th title="Current Ability">Meta</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 2. Stash / Projects -->
        <div class="card" style="border-top: 4px solid var(--purple);">
            <h2>üíé The "Process" (Stash)</h2>
            <p>Young players (<=24) with elite physical tools. <strong>DO NOT CUT.</strong></p>
            <table id="projectTable">
                <thead><tr><th>Name (Age)</th><th>Physical Profile</th><th>Potential</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 3. Trade Bait / Cuts -->
        <div class="card" style="border-top: 4px solid var(--red);">
            <h2>‚úÇÔ∏è Roster Cloggers (Cut/Trade)</h2>
            <p>Low upside. Either old & slow, or young & unathletic.</p>
            <table id="cutTable">
                <thead><tr><th>Name (Age)</th><th>Issue</th><th>Metric</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 4. League Targets -->
        <div class="card" style="border-top: 4px solid var(--green);">
            <h2>üéØ League Trade Targets</h2>
            <p>Undervalued assets on other teams.</p>
            <table id="targetTable">
                <thead><tr><th>Name (Age)</th><th>Team</th><th>Archetype</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let allPlayers = [];
    let teams = new Set();

    document.getElementById('csvInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { parseCSV(e.target.result); };
        reader.readAsText(file);
    });

    function parseCSV(csv) {
        const lines = csv.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        if (!headers.includes('Hgt') && !headers.includes('hgt')) {
            alert("‚ö†Ô∏è Please upload the Player RATINGS file (not stats). Need Hgt, Spd, Jmp.");
            return;
        }

        allPlayers = [];
        teams.clear();

        for(let i = 1; i < lines.length; i++) {
            if(!lines[i].trim()) continue;
            const currentline = lines[i].split(',');
            let player = {};
            
            for(let j = 0; j < headers.length; j++) {
                let header = headers[j].toLowerCase().replace('%','').replace(' ','');
                let val = currentline[j];
                if(!isNaN(val) && val.trim() !== "") val = parseFloat(val);
                player[header] = val;
            }
            
            calculateMetrics(player);
            if(player.team && player.team !== "") teams.add(player.team);
            allPlayers.push(player);
        }

        const select = document.getElementById('teamSelect');
        select.innerHTML = '';
        Array.from(teams).sort().forEach(t => {
            let opt = document.createElement('option');
            opt.value = t;
            opt.innerHTML = t;
            select.appendChild(opt);
        });
        document.getElementById('teamSelectorArea').style.display = 'block';
    }

    function calculateMetrics(p) {
        const get = (val) => (typeof val === 'number' && !isNaN(val)) ? val : 0;

        // 1. Current Game Impact (Meta Score)
        // Weighted heavily towards Height and IQ for current performance
        p.metaScore = (
            (get(p.hgt) * 2.8) + 
            (get(p.spd) * 1.0) + 
            (get(p.jmp) * 0.8) + 
            (get(p.oiq) * 1.5) + 
            (get(p.diq) * 1.2) + 
            (get(p.drb) * 0.8) + 
            (get(p.pss) * 0.8) + 
            (get(p.reb) * 0.8) + 
            (get(p['3pt']) * 0.6) 
        );

        // 2. Physical Ceiling (For Young Players)
        // Pure athleticism. Skills can be learned, height cannot.
        p.physicalScore = (get(p.hgt) * 2.5) + get(p.spd) + get(p.jmp) + (get(p.str) * 0.5);

        // 3. Functional Tags
        p.isBallHandler = (get(p.drb) + get(p.pss)) / 2 > 50;
        p.isBig = get(p.hgt) > 60 || (get(p.hgt) > 50 && get(p.str) > 60);
        
        // 4. Classification
        if (p.age <= 24) {
            // Young players are judged by Physicals
            if (p.physicalScore > 200) p.archetype = "Elite Prospect";
            else if (p.physicalScore > 160) p.archetype = "Rotation Prospect";
            else p.archetype = "Low Ceiling";
        } else {
            // Old players are judged by Meta Score (Current Ability)
            if (p.metaScore > 600) p.archetype = "Star Vet";
            else if (p.metaScore > 450) p.archetype = "Role Vet";
            else p.archetype = "Washed";
        }
    }

    function runAnalysis() {
        const myTeamName = document.getElementById('teamSelect').value;
        const myPlayers = allPlayers.filter(p => p.team === myTeamName);
        const otherPlayers = allPlayers.filter(p => p.team !== myTeamName);

        document.getElementById('results').style.display = 'grid';
        
        buildLineup(myPlayers);
        buildProjects(myPlayers);
        buildCuts(myPlayers);
        buildTargets(otherPlayers);
    }

    function buildLineup(roster) {
        // Sort by current ability (Meta Score)
        let sorted = [...roster].sort((a, b) => b.metaScore - a.metaScore);
        let starters = sorted.slice(0, 5);

        // Logic: Ensure at least 1 Ball Handler
        let hasHandler = starters.some(p => p.isBallHandler);
        if (!hasHandler) {
            let bestHandler = sorted.slice(5).find(p => p.isBallHandler);
            if (bestHandler) {
                starters.pop(); // Remove 5th best
                starters.push(bestHandler); // Add handler
            }
        }

        // Sort for display
        starters.sort((a, b) => b.metaScore - a.metaScore);

        const tbody = document.querySelector('#starterTable tbody');
        tbody.innerHTML = '';
        starters.forEach(p => {
            let colorClass = p.metaScore > 600 ? 'val-elite' : 'val-good';
            tbody.innerHTML += `<tr>
                <td><b>${p.name}</b> <small>(${p.age})</small></td>
                <td>${p.hgt >= 55 ? 'Frontcourt' : 'Backcourt'}</td>
                <td class="${colorClass} stat-val">${Math.round(p.metaScore)}</td>
            </tr>`;
        });
    }

    function buildProjects(roster) {
        const tbody = document.querySelector('#projectTable tbody');
        tbody.innerHTML = '';

        // Filter: Young players who might NOT be starters, but have high physicals
        let projects = roster.filter(p => p.age <= 25);
        
        // Sort by Physical Score (Ceiling)
        projects.sort((a, b) => b.physicalScore - a.physicalScore);

        projects.slice(0, 5).forEach(p => {
            let isRaw = p.metaScore < 450; // Good physicals, bad skills
            let status = isRaw ? `<span class="tag tag-stash">Raw Gem</span>` : `<span class="tag tag-core">Core</span>`;
            
            tbody.innerHTML += `<tr>
                <td><b>${p.name}</b> <small>(${p.age})</small> ${status}</td>
                <td>H:${p.hgt} S:${p.spd} J:${p.jmp}</td>
                <td class="stat-val">${Math.round(p.physicalScore)}</td>
            </tr>`;
        });
    }

    function buildCuts(roster) {
        const tbody = document.querySelector('#cutTable tbody');
        tbody.innerHTML = '';

        let cuts = roster.filter(p => {
            // 1. Old and bad (Washed)
            if (p.age > 26 && p.metaScore < 400) return true;
            
            // 2. Young but physically limited (No upside)
            // If you are 22, 5'10" (hgt < 30) and slow (spd < 50), you will never be good in BBGM.
            if (p.age <= 25 && p.hgt < 35 && p.spd < 55 && p.metaScore < 400) return true;
            
            return false;
        });

        cuts.sort((a, b) => a.metaScore - b.metaScore); // Worst first

        if (cuts.length === 0) tbody.innerHTML = '<tr><td colspan="3">Roster looks clean!</td></tr>';

        cuts.forEach(p => {
            let reason = "";
            if (p.age > 26) reason = "Declining / Low Skill";
            else reason = "Low Physical Ceiling";

            tbody.innerHTML += `<tr>
                <td>${p.name}</td>
                <td>${p.age}</td>
                <td class="val-bad">${reason}</td>
            </tr>`;
        });
    }

    function buildTargets(others) {
        const tbody = document.querySelector('#targetTable tbody');
        tbody.innerHTML = '';

        // Target Logic:
        // 1. "The Freak": Age <= 23, Height > 60, Speed > 60 (Giannis/Wemby types)
        // 2. "The Sniper": 3pt > 70, Age < 28 (Spacing)
        // 3. "The General": Dribble + Pass > 140 combined (Elite handler)
        
        let targets = others.filter(p => {
            let isFreak = p.age <= 23 && p.hgt > 60 && p.spd > 50;
            let isYoungElite = p.age <= 24 && p.physicalScore > 200;
            return isFreak || isYoungElite;
        });

        targets.sort((a, b) => b.physicalScore - a.physicalScore);

        targets.slice(0, 8).forEach(p => {
            let type = "Prospect";
            if(p.hgt > 70) type = "Unicorn Big";
            else if(p.spd > 75) type = "Speedster";
            
            tbody.innerHTML += `<tr>
                <td><b>${p.name}</b> <small>(${p.age})</small></td>
                <td><small>${p.team}</small></td>
                <td class="val-mid">${type}</td>
            </tr>`;
        });
    }
</script>

</body>
</html>